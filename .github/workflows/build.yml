name: Build Windows App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-windows:
    name: ðŸªŸ Build Windows Exe
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_gui.txt
          pip install pyinstaller

      # Install the browser binary into the GitHub Runner
      - name: Install Playwright Chromium
        run: playwright install chromium

      # We use an embedded Python script to find the browser path and run PyInstaller
      # This is much safer than using PowerShell for complex path mapping
      - name: Build with PyInstaller
        shell: python
        run: |
          import os
          import subprocess
          import sys
          import glob

          # --- CONFIGURATION ---
          APP_NAME = "PhilGEPS_ScraperV2"
          ENTRY_SCRIPT = "scraper_gui.py"
          ICON_PATH = r"assets\icon.ico"
          # NOTE: Using the filename from your provided file list (contains typo 'congfig')
          CONFIG_FILE = "categories_congfig.json"

          print(f"--- Starting Build for {APP_NAME} ---")

          # 1. LOCATE CHROMIUM BROWSER
          # On Windows, Playwright installs to %LOCALAPPDATA%\ms-playwright
          pw_root = os.path.join(os.environ['LOCALAPPDATA'], 'ms-playwright')
          
          try:
              # Find folders starting with 'chromium-'
              browsers = glob.glob(os.path.join(pw_root, 'chromium-*'))
              if not browsers:
                  raise FileNotFoundError("No chromium browsers found in ms-playwright folder")
              
              # Sort to ensure we get the latest version if multiple exist
              browsers.sort()
              latest_browser_path = browsers[-1]
              browser_folder_name = os.path.basename(latest_browser_path)
              print(f"Found Chromium at: {latest_browser_path}")
          except Exception as e:
              print(f"Error finding browser: {e}")
              sys.exit(1)

          # 2. DEFINE DATA MAPPINGS (Source;Dest)
          # We map the browser to: playwright/driver/package/.local-browsers/chromium-xxxx
          # This matches the logic in your scraper_gui.py
          dest_browser_path = f"playwright/driver/package/.local-browsers/{browser_folder_name}"
          
          add_data_browser = f"{latest_browser_path};{dest_browser_path}"
          add_data_config = f"{CONFIG_FILE};."

          # 3. CONSTRUCT PYINSTALLER COMMAND
          cmd = [
              'pyinstaller',
              '--noconsole',       # GUI mode (no black command window)
              '--onefile',         # Single .exe file
              '--clean',
              '--name', APP_NAME,
              
              # Collect dependencies that PyInstaller sometimes misses
              '--collect-all', 'customtkinter',
              '--collect-all', 'playwright',
              
              # Bundle the Browser and Config
              '--add-data', add_data_browser,
              '--add-data', add_data_config,
              
              # Main Script
              ENTRY_SCRIPT
          ]

          # Add Icon if it exists
          if os.path.exists(ICON_PATH):
              print(f"Using icon: {ICON_PATH}")
              cmd.insert(4, f'--icon={ICON_PATH}')
          else:
              print(f"WARNING: Icon not found at {ICON_PATH}. Building with default icon.")

          # 4. RUN BUILD
          print("Command:", " ".join(cmd))
          subprocess.check_call(cmd)

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PhilGEPS_ScraperV2_Windows
          path: dist/PhilGEPS_ScraperV2.exe