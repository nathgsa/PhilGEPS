name: Build Standalone Executables

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # WINDOWS â€” produces zero-dependency .exe with Chromium bundled
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-windows:
    name: ğŸªŸ Build Windows .exe
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python packages
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller Pillow
          pip install playwright customtkinter pandas requests beautifulsoup4 lxml

      # â”€â”€ Generate icons (encoding-safe now) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate application icons
        run: python create_icons.py
        shell: pwsh

      # â”€â”€ Install Chromium (will be bundled into .exe) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Playwright Chromium
        run: |
          $browsersPath = "$env:GITHUB_WORKSPACE\pw-browsers"
          New-Item -ItemType Directory -Force -Path $browsersPath | Out-Null
          $env:PLAYWRIGHT_BROWSERS_PATH = $browsersPath
          playwright install chromium
          echo "PLAYWRIGHT_BROWSERS_PATH=$browsersPath" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Verify Chromium installation
        run: |
          Write-Host "Browsers path: $env:PLAYWRIGHT_BROWSERS_PATH"
          if (Test-Path "$env:PLAYWRIGHT_BROWSERS_PATH") {
            Get-ChildItem "$env:PLAYWRIGHT_BROWSERS_PATH" -Directory | Select-Object Name
          }
        shell: pwsh

      # â”€â”€ Build the .exe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build .exe with PyInstaller
        run: pyinstaller philgeps_scraper.spec --clean --noconfirm
        shell: pwsh

      - name: Verify build output
        run: |
          $exePath = "dist\PhilGEPS_ScraperV2.exe"
          if (Test-Path $exePath) {
            $sizeMB = [math]::Round((Get-Item $exePath).Length / 1MB, 1)
            Write-Host "SUCCESS: $exePath ($sizeMB MB)"
          } else {
            Write-Error "FAILED: $exePath not found"
            exit 1
          }
        shell: pwsh

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: PhilGEPS_ScraperV2_Windows
          path: dist/PhilGEPS_ScraperV2.exe
          retention-days: 30

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # macOS â€” produces .app WITHOUT Chromium (user installs it separately)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-macos:
    name: ğŸ Build macOS .app
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python packages
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller Pillow
          pip install playwright customtkinter pandas requests beautifulsoup4 lxml

      # â”€â”€ Generate icons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate icon PNG
        run: python create_icons.py

      - name: Create .icns file
        run: |
          mkdir -p assets/icon.iconset
          
          # Generate all required sizes
          for size in 16 32 64 128 256 512; do
            sips -z $size $size assets/icon.png \
              --out assets/icon.iconset/icon_${size}x${size}.png
            sips -z $((size*2)) $((size*2)) assets/icon.png \
              --out assets/icon.iconset/icon_${size}x${size}@2x.png
          done
          
          # Build the .icns file
          iconutil -c icns assets/icon.iconset -o assets/icon.icns
          echo "Created: $(ls -lh assets/icon.icns)"

      # â”€â”€ CRITICAL: Skip Chromium installation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # We're NOT bundling Chromium on macOS (avoids codesign errors).
      # The spec file skips browser bundling on macOS automatically.
      # Users will install Chromium once after downloading the .app.

      # â”€â”€ Build the .app bundle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build .app with PyInstaller
        run: pyinstaller philgeps_scraper.spec --clean --noconfirm

      - name: Verify build output
        run: |
          if [ -d "dist/PhilGEPS_ScraperV2.app" ]; then
            SIZE=$(du -sh "dist/PhilGEPS_ScraperV2.app" | cut -f1)
            echo "SUCCESS: dist/PhilGEPS_ScraperV2.app ($SIZE)"
          else
            echo "FAILED: dist/PhilGEPS_ScraperV2.app not found" && exit 1
          fi

      # â”€â”€ Package for distribution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Package .app for distribution
        run: |
          chmod +x "dist/PhilGEPS_ScraperV2.app/Contents/MacOS/PhilGEPS_ScraperV2"
          cd dist
          zip -r --symlinks PhilGEPS_ScraperV2_macOS.zip PhilGEPS_ScraperV2.app
          echo "Package size: $(du -sh PhilGEPS_ScraperV2_macOS.zip | cut -f1)"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: PhilGEPS_ScraperV2_macOS
          path: dist/PhilGEPS_ScraperV2_macOS.zip
          retention-days: 30

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # RELEASE â€” attaches both files to GitHub Release (tag pushes only)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    name: ğŸ“¦ Create GitHub Release
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    permissions:
      contents: write

    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: PhilGEPS_ScraperV2_Windows
          path: release-assets/

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: PhilGEPS_ScraperV2_macOS
          path: release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "PhilGEPS ScraperV2 ${{ github.ref_name }}"
          body: |
            ## PhilGEPS ScraperV2 ${{ github.ref_name }}

            ### â¬‡ï¸ Downloads

            | Platform | File | Setup Required? |
            |----------|------|-----------------|
            | ğŸªŸ Windows | `PhilGEPS_ScraperV2.exe` | **Zero setup** â€” Chromium bundled |
            | ğŸ macOS | `PhilGEPS_ScraperV2_macOS.zip` | **One-time Chromium install** |

            ---

            ### ğŸªŸ Windows â€” Zero Setup

            1. Download `PhilGEPS_ScraperV2.exe` (~300 MB)
            2. Double-click to run
            3. If SmartScreen warns: **More info** â†’ **Run anyway**

            **Chromium browser is bundled** â€” no installation needed.

            **To pin to taskbar:** Right-click â†’ **Pin to taskbar**

            ---

            ### ğŸ macOS â€” One-Time Setup

            macOS apps cannot bundle Chromium due to code-signing limitations.
            You need to install it **once** before first use:

            **Step 1: Install Chromium (one-time only)**
            ```bash
            # Open Terminal and run:
            pip3 install playwright
            playwright install chromium
            ```

            **Step 2: Download and unzip**
            ```bash
            unzip ~/Downloads/PhilGEPS_ScraperV2_macOS.zip
            ```

            **Step 3: Bypass Gatekeeper (first launch only)**
            ```bash
            xattr -cr "PhilGEPS_ScraperV2.app"
            open "PhilGEPS_ScraperV2.app"
            ```

            **After first-time setup:**
            Just double-click `PhilGEPS_ScraperV2.app` to run.

            **To add to Dock:**
            Drag to `/Applications`, then drag from Applications to Dock.

            **Don't have pip/Python?**
            - Install Homebrew: `/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"`
            - Then run: `brew install python3`
            - Then run the Chromium install commands above

            ---

            ### ğŸ“ What's New

            - **Windows:** Zero-dependency .exe with bundled Chromium browser
            - **macOS:** Lightweight .app (Chromium installed separately)
            - **Fixed:** Data cleaner date/currency parsing bugs
            - **Fixed:** Thread-safe browser pooling (10Ã— faster scraping)
            - **New:** Desktop icons for both platforms

            See [WHATS_NEW_V2.md](WHATS_NEW_V2.md) for full changelog.
          files: |
            release-assets/PhilGEPS_ScraperV2.exe
            release-assets/PhilGEPS_ScraperV2_macOS.zip
          draft: false
          prerelease: false
