name: Build Windows App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-windows:
    name: ðŸªŸ Build Windows Exe
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_gui.txt
          pip install pyinstaller

      # FIX: Use 'python -m' to call playwright, avoiding PATH issues
      - name: Install Playwright Chromium
        run: python -m playwright install chromium

      # We use an embedded Python script to handle the complex build logic
      - name: Build with PyInstaller
        shell: python
        run: |
          import os
          import subprocess
          import sys
          import glob
          import shutil

          # --- CONFIGURATION ---
          APP_NAME = "PhilGEPS_ScraperV2"
          ENTRY_SCRIPT = "scraper_gui.py"
          # Note: Using 'assets/icon.ico' (forward slash works in Python on Win)
          ICON_PATH = "assets/icon.ico" 
          # Note: Using the filename from your provided file list (contains typo 'congfig')
          CONFIG_FILE = "categories_congfig.json"

          print(f"--- Starting Build for {APP_NAME} ---")

          # 1. LOCATE CHROMIUM BROWSER
          # On Windows, Playwright installs to %LOCALAPPDATA%\ms-playwright
          pw_root = os.path.join(os.environ['LOCALAPPDATA'], 'ms-playwright')
          
          # Find folders starting with 'chromium-'
          chromium_dirs = glob.glob(os.path.join(pw_root, 'chromium-*'))
          
          if not chromium_dirs:
              print(f"Error: No Chromium found in {pw_root}")
              # fallback check in user profile just in case
              pw_root_2 = os.path.join(os.path.expanduser("~"), "AppData", "Local", "ms-playwright")
              chromium_dirs = glob.glob(os.path.join(pw_root_2, 'chromium-*'))
              if not chromium_dirs:
                  print("Critical Error: Could not locate Playwright browser.")
                  sys.exit(1)

          # Sort to ensure we get the latest version if multiple exist
          chromium_dirs.sort()
          latest_browser_path = chromium_dirs[-1]
          browser_folder_name = os.path.basename(latest_browser_path)
          print(f"Found Chromium at: {latest_browser_path}")

          # 2. DEFINE DATA MAPPINGS (Source;Dest)
          # We map the browser to: playwright/driver/package/.local-browsers/chromium-xxxx
          # This matches the logic in your scraper_gui.py
          dest_browser_path = f"playwright/driver/package/.local-browsers/{browser_folder_name}"
          
          # Windows uses semicolon ; for separators
          add_data_browser = f"{latest_browser_path};{dest_browser_path}"
          add_data_config = f"{CONFIG_FILE};."

          # 3. CONSTRUCT PYINSTALLER COMMAND
          cmd = [
              'pyinstaller',
              '--noconsole',       # GUI mode (no black command window)
              '--onefile',         # Single .exe file
              '--clean',
              '--name', APP_NAME,
              
              # Collect dependencies that PyInstaller sometimes misses
              '--collect-all', 'customtkinter',
              '--collect-all', 'playwright',
              
              # Bundle the Browser and Config
              '--add-data', add_data_browser,
              '--add-data', add_data_config,
              
              # Main Script
              ENTRY_SCRIPT
          ]

          # Add Icon if it exists
          if os.path.exists(ICON_PATH):
              print(f"Using icon: {ICON_PATH}")
              # Insert icon argument before the script name
              cmd.insert(5, f'--icon={ICON_PATH}')
          else:
              print(f"WARNING: Icon not found at {ICON_PATH}. Building with default icon.")

          # 4. RUN BUILD
          print("Command:", " ".join(cmd))
          subprocess.check_call(cmd)

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PhilGEPS_ScraperV2_Windows
          path: dist/PhilGEPS_ScraperV2.exe